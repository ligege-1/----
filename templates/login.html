<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>OODaiP聊天室 - 登录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <script src="/static/js/jquery-3.7.1.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1677FF',
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center font-sans">

<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
    <div class="bg-primary p-6 text-center">
        <i class="fas fa-comments text-4xl text-white mb-3"></i>
        <h2 class="text-white text-2xl font-bold">OODaiP聊天室</h2>
        <p class="text-white/80 mt-1">连接同事，畅聊工作</p>
    </div>
    <div class="p-6">
        <!-- Tabs -->
        <div class="flex mb-6 border-b">
            <button id="tab-login" class="flex-1 py-2 text-primary border-b-2 border-primary font-bold focus:outline-none transition-colors">登录</button>
            <button id="tab-register" class="flex-1 py-2 text-gray-500 hover:text-primary focus:outline-none transition-colors">注册</button>
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="username">
                用户名
            </label>
            <input class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" id="username" type="text" placeholder="请输入您的用户名">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                密码
            </label>
            <input class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" id="password" type="password" placeholder="请输入密码">
        </div>
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="server-select">
                选择服务器
            </label>
            <select class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" id="server-select">
                <option value="">正在加载服务器列表...</option>
            </select>
        </div>
        <div class="flex items-center justify-between">
            <button class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-lg focus:outline-none focus:shadow-outline transition-colors w-full" id="action-btn">
                登录
            </button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        var isRegister = false;

        // Load config
        $.getJSON('/api/config', function(data) {
            var $select = $('#server-select');
            $select.empty();
            if (data.servers && data.servers.length > 0) {
                data.servers.forEach(function(server) {
                    $select.append($('<option>', {
                        value: server.url,
                        text: server.name
                    }));
                });
            } else {
                $select.append($('<option>', {
                    value: '',
                    text: '无可用服务器'
                }));
            }
        });

        $('#tab-login').click(function() {
            isRegister = false;
            $(this).addClass('text-primary border-b-2 border-primary font-bold').removeClass('text-gray-500');
            $('#tab-register').addClass('text-gray-500').removeClass('text-primary border-b-2 border-primary font-bold');
            $('#action-btn').text('登录');
        });

        $('#tab-register').click(function() {
            isRegister = true;
            $(this).addClass('text-primary border-b-2 border-primary font-bold').removeClass('text-gray-500');
            $('#tab-login').addClass('text-gray-500').removeClass('text-primary border-b-2 border-primary font-bold');
            $('#action-btn').text('注册');
        });

        function handleAction() {
            var username = $('#username').val().trim();
            var password = $('#password').val().trim();
            var serverUrl = $('#server-select').val();

            if (!username) {
                alert('请输入用户名');
                return;
            }
            if (!password) {
                alert('请输入密码');
                return;
            }
            if (!serverUrl) {
                alert('请选择服务器地址');
                return;
            }

            var $btn = $('#action-btn');
            var originalText = $btn.text();
            $btn.prop('disabled', true).text('处理中...');

            var endpoint = isRegister ? '/api/register' : '/api/login';
            var url = serverUrl + endpoint;

            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ username: username, password: password }),
                success: function(response) {
                    if (response.success) {
                        if (isRegister) {
                            alert('注册成功，请登录');
                            $('#tab-login').click();
                            $('#password').val(''); // Clear password
                            // Do not restore originalText ('注册') here, as we switched to login mode
                            $btn.prop('disabled', false); 
                        } else {
                            // Login success
                            localStorage.setItem('chat_server_url', serverUrl);
                            window.location.href = '/chat?nickname=' + encodeURIComponent(username);
                        }
                    } else {
                        alert(response.message || '操作失败');
                        $btn.prop('disabled', false).text(originalText);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    alert('无法连接到服务器或发生错误');
                    $btn.prop('disabled', false).text(originalText);
                }
            });
        }

        $('#action-btn').click(handleAction);
        $('#username, #password').keypress(function(e) {
            if (e.which == 13) handleAction();
        });
    });
</script>
</body>
</html>
